# Rate limiting zone - 10MB memory, allows 10 requests per second per IP
limit_req_zone $binary_remote_addr zone=tile_limit:10m rate=10r/s;

# Tile cache configuration - 500MB max size, inactive tiles removed after 7 days
proxy_cache_path /Users/himanshuyadav/developer/map-tile-server/cache
                 levels=1:2
                 keys_zone=tile_cache:10m
                 max_size=500m
                 inactive=7d
                 use_temp_path=on;

server {
    listen 3000;
    server_name map.localhost;

    # DNS resolver for proxy requests
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # Serve the main HTML page
    location / {
        root /Users/himanshuyadav/developer/map-tile-server/public;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # Serve map tiles - try local files first, then proxy to OpenStreetMap
    location ~ ^/tiles/(\d+)/(\d+)/(\d+)\.png$ {
        # Try local tiles first, fall back to proxy
        root /Users/himanshuyadav/developer/map-tile-server;
        try_files /tiles/$1/$2/$3.png @tile_proxy;

        # Rate limiting - burst of 20 requests allowed
        limit_req zone=tile_limit burst=20 nodelay;

        # Enable CORS for tiles
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';

        # Browser cache for 3 days
        expires 3d;
        add_header Cache-Control "public, immutable";
    }

    # Proxy location for fetching tiles from OpenStreetMap
    location @tile_proxy {
        # Enable nginx caching
        proxy_cache tile_cache;
        proxy_cache_valid 200 8d;

        # Show cache status in response header (HIT, MISS, BYPASS)
        add_header X-Cache-Status $upstream_cache_status;

        # Rewrite to remove /tiles/ prefix before proxying
        rewrite ^/tiles/(.*)$ /$1 break;

        # Fetch from OpenStreetMap tile server
        proxy_pass https://tile.openstreetmap.org;

        # Set proper headers for proxy request
        proxy_set_header Host tile.openstreetmap.org;
        proxy_set_header User-Agent "MapTileServer/1.0";

        # Enable CORS
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';

        # Browser cache for 3 days
        expires 3d;
    }

    # Logs
    access_log /opt/homebrew/var/log/nginx/map-tile-server.access.log;
    error_log /opt/homebrew/var/log/nginx/map-tile-server.error.log;
}
